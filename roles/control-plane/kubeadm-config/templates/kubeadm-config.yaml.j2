apiVersion: kubeadm.k8s.io/v1alpha2
kind: MasterConfiguration
kubernetesVersion: v1.11.0
apiServerCertSANs:
- "{{ load_balancer_dns }}"
api:
    controlPlaneEndpoint: "{{ load_balancer_dns }}:{{ load_balancer_port | default(443) }}"
etcd:
    local:
        extraArgs:
            listen-client-urls: "https://127.0.0.1:2379,https://{{ ansible_eth1.ipv4.address }}:2379"
            advertise-client-urls: "https://{{ ansible_eth1.ipv4.address }}:2379"
            listen-peer-urls: "https://{{ ansible_eth1.ipv4.address }}:2380"
            initial-advertise-peer-urls: "https://{{ ansible_eth1.ipv4.address }}:2380"
{% if ansible_hostname == 'cp1' %}
            initial-cluster: "{{ ansible_hostname }}=https://{{ ansible_eth1.ipv4.address }}:2380"
{% endif %}
{% if ansible_hostname == 'cp2' %}
            initial-cluster: "{% for h in groups['control-plane'] %}{% if hostvars[h]['ansible_hostname'] == 'cp1' %}{{ hostvars[h]['ansible_hostname'] }}=https://{{ hostvars[h]['ansible_eth1']['ipv4']['address'] }}:2380,{% endif %}{% endfor %}{{ ansible_hostname }}=https://{{ ansible_eth1.ipv4.address }}:2380"
{% endif %}
{% if ansible_hostname == 'cp3' %}
            initial-cluster: "{% for h in groups['control-plane'] %}{% if hostvars[h]['ansible_hostname'] == 'cp1' %}{{ hostvars[h]['ansible_hostname'] }}=https://{{ hostvars[h]['ansible_eth1']['ipv4']['address'] }}:2380,{% endif %}{% endfor %}{% for h in groups['control-plane'] %}{% if hostvars[h]['ansible_hostname'] == 'cp2' %}{{ hostvars[h]['ansible_hostname'] }}=https://{{ hostvars[h]['ansible_eth1']['ipv4']['address'] }}:2380,{% endif %}{% endfor %}{{ ansible_hostname }}=https://{{ ansible_eth1.ipv4.address }}:2380"
{% endif %}
{% if ansible_hostname != 'cp1' %}
            initial-cluster-state: existing
{% endif %}
        serverCertSANs:
        - {{ ansible_hostname }}
        - {{ ansible_eth1.ipv4.address }}
        peerCertSANs:
        - {{ ansible_hostname }}
        - {{ ansible_eth1.ipv4.address }}
networking:
    # This CIDR is a calico default. Substitute or remove for your CNI provider.
    podSubnet: "192.168.0.0/16"
